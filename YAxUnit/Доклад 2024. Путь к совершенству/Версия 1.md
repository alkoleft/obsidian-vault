Приветствую, меня зовут Алексей, разработчик YAxUnit.

Сегодня я расскажу процесс разработки и проблемах с которыми столкнулись и путях их решения. О нововведениях и многом другом.


1. YAxUnit - инструмент для тестирования продуктов на платформе 1сПредприятие. Это относительно молодой инструмент, представленный сообществу два года назад на конференции infostart и выложен на github.
2. Это open-source проект от крупной ИТ компании с большой экспертизой разработки на 1с.
3. Предназначен для модульного тестирования 1с, те тестирования минимальных логических блоков конфигураций
4. Набирает популярность, ему еще далеко до VA, но все же не редко встречается в вакансиях. В последнее время замечен растущий интерес QA инженеров
За эти два года YAxUnit претерпел множество изменений как внешних так и внутренних. Появилось много новых фитч, полноценная документаций и CI. Выполнен рефакторинг всего и вся - переписаны почти каждая строка движка.

Проблемы:
* Документация
* Обратная совместимость
* Проверки кода и помогаторы
* Большое количество различных хотелок
* Работа с реквестами
* Различные варианты использования
	* Разные версии платформ
	* Режимы совместимости
	* Типы запуска предприятия (обычное и управляемое, толстый и тонкий, файловая и клиент-серверная)
	* Разные конфигурации
	* Разные ОС
	* Разные локали и варианты встроенного языка
* Работа в EDT и конфигураторе


Выпущено 12 релизов, закрыто больше 160 реквестов, набрали 175 звезд


**Кроме кроме собственно написания кода сразу же столкнулись с двумя проблемами:**
1. Документация - первая версия ее была, как бы это сказать, скудная. Первые энтузиасты, привыкшие к работе с опенсурс проектами справились с этим с легкостью. Но для полноценного погружения ее нехватало, в связи с этим даже появился цикл видео. В общем документация - на мой взгляд титаническая, но очень важная задача, она была решена за эти два года.
2. Обратная совместимость, yaxunit - открытый инструмент, который используют многие и у нас нет доступа к этим многим. Поэтому все изменения, которых не мало не должны ломать совместимость. Пользователи не простят если их тесты упадут просто от обновления движка.
	Для решения этой проблемы мы используем:
	1. Физическое разделение публичного и служебного программного интерфейсов.
		При разделении областями велика вероятность того, что тестировщик воспользуется методом из служебной области.
	2. Большое внимание к неймингу и сигнатуре метода, релизнув раз уже пере переделаешь.
	3. В паблике необходимый минимум
	4. Механизм депрекейтов, методы не удаляются, а помечаются особым образом
Плюсом, для обоих проблем выступает покрытие тестами - тесты это
1. Примеры использования, своего рода документация
2. Тесты контролируют совместимость - при поломке начинают падать.
3. Причем тестами в основном покрывается только публичный интерфейс и это позволяет контролировать заявленную функциональность и избежать излишних затрат при доработках. Минимизированы доработки тестов при большом количестве доработок самого движка.

**Не забываем что разработчик человек ленивый, поэтому необходимо минимизировать затраты на сопровождение и контроль разработки.**

Для этого используется 
1. Автоматизация с использованием github CI:
	1. Проверки сонаром
	2. Автоматизированное тестирование
	3. Сборка артефактов
	4. Генерация описания программного интерфейсам на основании комментариев
	5. Публикация документации
	6. Создание релизов, описании и артефакты
	7. Контроль PR
	8. Добавлен шаблон PR и issue
2. Скрипты прекоммита
3. Плагин для запуска и генерации тестов
4. LLM для генерации описаний методов и написания тестов

Фитчи

**Мокирование**
* Реализована возможность мокирования HTTP сервисов. Эмулятор для `HTTPСервисЗапрос`
* Эмулятор для `ADO.RecordSet`
* Поддержка мокирования для всех объектов конфигурации
* Обучение на цепочках вызовов (например вызвать исключение на 3м вызове метода без параметров)
* Доступ к статистике вызовов методов при проверке
* Указание условий на параметры с помощью предикатов
* Настройка мокирования. Сократить настройку мокирования цепочки вызовов одного метода
**Тестовые данные**
* Механизм удаления тестовых данных (работа на клиенте и вне транзакции)
* Конструктор объектов (документы, справочники, записи регистров) с его кллиер фитчей **фикция**
* Подражатель. Спасибо [@Daabramov](https://github.com/Daabramov)
* Случайные даты, значения перечислений, предопределенных
* Загрузка данных из табличного документа или таблицы markdown, [документация](https://bia-technologies.github.io/yaxunit/docs/user-api/test-data/#%D0%B7%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D0%BA%D0%B0-%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85-%D0%B8%D0%B7-%D0%BC%D0%B0%D0%BA%D0%B5%D1%82%D0%BE%D0%B2) [#133](https://github.com/bia-technologies/yaxunit/issues/133). Спасибо [@dlyubanevich](https://github.com/dlyubanevich)
* Конструктор объектов XDTO
* Работа с временными файлами и каталогами
* Удаление тестовых данных без учета прав [#309](https://github.com/bia-technologies/yaxunit/pull/309), спасибо [@goodwinvu](https://github.com/goodwinvu)
**Форматы отчетов**
* Отчет в формате allure
**Утверждения**
- НачинаетсяС
- ЗаканчиваетсяНа
- МеждуВключаяГраницы
- МеждуИсключаяГраницы
- МеждуВключаяНачалоГраницы
- МеждуВключаяОкончаниеГраницы
- КаждыйЭлементСодержитСвойство
- КаждыйЭлементСодержитСвойствоСоЗначением
- ЛюбойЭлементСодержитСвойство
- ЛюбойЭлементСодержитСвойствоСоЗначением
- ИмеетМетод
- ВСписке
- Утверждения для проверки таблиц информационной базы
- Добавить в ассерты и предикаты поддержку проверки по регулярному выражению [#138](https://github.com/bia-technologies/yaxunit/issues/138). Спасибо [@Daabramov](https://github.com/Daabramov)
- Поддержка предикатов
- Сравнение табличных документов по содержимому
**Разработка вне EDT**
* Форма работы с тестами из предприятия (просмотр, запуск, настройка)
*  В режиме предприятия реализовать вывод стека ошибок, так же как в EDT
* 
**Документация**
* Автогенерация и публикация описания API
* Сайт на docusaurus
* Переписана вся [документация](https://bia-technologies.github.io/yaxunit/)
* Включить поиск по документации
**Прочее**
* Переопределение обработчиков событий тестового модуля, [#124](https://github.com/bia-technologies/yaxunit/pull/124). Спасибо [@potoyalo](https://github.com/potoyalo)
* ВК для паузы, вывода с консоль, поддержки регулярных выражений
* Предикаты
* Фоновые блокировки
* Логирование (файл и в stdout)
* Упрощены многие механизмы движка
* Множество небольших доработок
* Исправлены ошибки
* Доработан движок для работы в режиме без использования синхронных методов
* Сравнение по содержимому (вложенным реквизитам и свойствам)
* Возможность получать данные с клиента и выполнять простые запросы
* Поддержка англоязычных конфигураций [#238](https://github.com/bia-technologies/yaxunit/pull/238) Спасибо [@RichardTheLionJokes](https://github.com/RichardTheLionJokes)
* Добавить метод получения движений документа
* Проверка зависших транзакций
* Добавить поддержку работу инструмента под не полноправным пользователем [#212](https://github.com/bia-technologies/yaxunit/issues/212) Спасибо [@stolya](https://github.com/stolya)
* Сбор лога выполнения теста
* - [NEW] Зависимости тестов [#314](https://github.com/bia-technologies/yaxunit/issues/314)
- [NEW] Добавить возможность указывать рабочий каталог в параметрах запуска [#313](https://github.com/bia-technologies/yaxunit/issues/313)
- [NEW] Зависимости тестов. Фабрика XDTO [#322](https://github.com/bia-technologies/yaxunit/issues/322)
- Рефакторинг механизма событий [#315](https://github.com/bia-technologies/yaxunit/issues/315)  Добавлена возможность создавать обработчики событий за пределами расширения движка, подробнее в

**Подробнее в CI.**

В современном мире без CI никуда, это не только дать моде, но и удобство, привычка. Существует множество различных платформ по организации CI среди них GitHub Actions, который позволяет бесплатно организовать CI для публичных проектов и имеет богатую библиотеку готовых шагов, кубиков из которых строятся процессы автоматизации.

1. Первым делом был подключен сонар, незаменимый помощник для контроля качества кода. Большое спасибо сообществу bsl ls, за их разработку и отдельное спасибо за сервер с сонаром для 1С. Рассказывать о его пользе думаю не стоит, многие и так уже ее познали.
	1. Для этого необходимо добавить проект в [https://sonar.openbsl.ru/](https://sonar.openbsl.ru/), с этим может помочь [@nixel](https://t.me/nixel2007)
	2. Написать задание ![[Pasted image 20240827173932.png]]
	3. Подобный путь проходили многие. Единственное что мы добавили: для удобства был создан специальный action, который публикует замечания сонара в реквест.![[Pasted image 20240827174209.png]]
	4. Публикация замечаний
		1. Удобство контроля, при ревью реквеста, не забываешь посмотреть замечания
		2. Контрибьютеру нет необходимости самостоятельно смотреть замечания, до которых не так просто добраться.
2. Сборка документации
	1. Для документации был выбран Docusaurus - инструмент для создания сайтов документации. Классный, модный, молодой, активно развивающийся, с большим количеством возможностей и плагинов.
	2. Он формирует документацию из Markdown, в котором мы и так уже ведем документацию, но также расширяет синтаксис: предупреждения, табы, mdx компоненты. Имеет поддержку диаграмм с использованием mermaid и подсветку синтаксиса с помощь prism, которая умеет bsl.
	3. С помощью плагинов можно добавлять разные классные фитчи, например поиск с использованием LLM.
	4. А тут сделаем небольшое отступление, при выборе поискового плагина я наткнулся на проект markprompt, который в пару кликов дружит вашу документацию и gpt. В итоге получился умный поиск, который не только умеет нечеткий поиск и умеет отвечать на вопросы по документации, но и пишет тесты для простых методов. Лично для меня, человека который пользовался неросетями только в универе это было крайне неожиданно. GPT формировал реально работающие тесты с использованием YAxUnit. Сам сервис все еще находится в стадии тестирования, плюс нужна оплата, при превышении лимитов, а они небольшие, поэтому о нем пришлось на время забыть, но это был интересный опыт. В планах - изучить эту тему поподробнее и реализовать self-hosted сервис для использования gpt с базой знаний YAxUnit. PS. Другие бесплатные модели такие как lama или mistral увы не так хорошо справляются с задачей.
	5. Если есть желающие помочь с LLM буду признателен, также хочется обновить логотип, нужен upscale
	6. ![[Pasted image 20240827181210.png]]
3. Сборка и тестирование. Тестовый движок без автотестов - моветон. С тестирования YAxUnit на Github началось наше погружение в мир Github Actions и знакомство с ним, зверь оказался не так уж и страшен. Существует три типа действий: js, docker, composite. Мы выбрали вариант с JS/TS, тк они менее привередливые и более универсальные.
	Дверь в мир GHActions мне открыл Дима Медведев, мой коллега, который создал действия по установке и работе с ibcmd. Благодаря им мы смогли запустить тестирование 1с в среде GH.
![[Pasted image 20240828232344.png]]

Нами разработано:
* Действие по установке 1C:EDT и 1С:Предприятие `1CDevFlow/onec-setup-build-env-action`
* Действие для выполнения конвертации исходников в формат конфигуратора `1CDevFlow/onec-edtcli-command-action@main`
* Также доработано действие публикации отчета о тестировании ``
Благодарность

|[<img alt="alkoleft" src="https://avatars.githubusercontent.com/u/13838250?v=4&s=117" width="117">](https://github.com/alkoleft) |[<img alt="theshadowco" src="https://avatars.githubusercontent.com/u/9591731?v=4&s=117" width="117">](https://github.com/theshadowco) |[<img alt="bia-tech" src="https://avatars.githubusercontent.com/u/17024100?v=4&s=117" width="117">](https://github.com/bia-tech) |[<img alt="potoyalo" src="https://avatars.githubusercontent.com/u/1996464?v=4&s=117" width="117">](https://github.com/potoyalo) |
|:---: |:---: |:---: |:---: |
|[alkoleft](https://github.com/alkoleft) |[theshadowco](https://github.com/theshadowco) |[bia-tech](https://github.com/bia-tech) |[potoyalo](https://github.com/potoyalo) |
| [<img alt="alexandr-yang" src="https://avatars.githubusercontent.com/u/1947592?v=4&s=117" width="117">](https://github.com/alexandr-yang) | [<img alt="Daabramov" src="https://avatars.githubusercontent.com/u/31928832?v=4&s=117" width="117">](https://github.com/Daabramov) | [<img alt="SeiOkami" src="https://avatars.githubusercontent.com/u/42138875?v=4&s=117" width="117">](https://github.com/SeiOkami) | [<img alt="edkuznetsov" src="https://avatars.githubusercontent.com/u/31954121?v=4&s=117" width="117">](https://github.com/edkuznetsov) |
|                                             [alexandr-yang](https://github.com/alexandr-yang)                                             |                                             [Daabramov](https://github.com/Daabramov)                                              |                                             [SeiOkami](https://github.com/SeiOkami)                                              |                                             [edkuznetsov](https://github.com/edkuznetsov)                                              |
|[<img alt="azazulov" src="https://avatars.githubusercontent.com/u/147484264?v=4&s=117" width="117">](https://github.com/azazulov) |[<img alt="ViktorErmakov" src="https://avatars.githubusercontent.com/u/39617680?v=4&s=117" width="117">](https://github.com/ViktorErmakov) |[<img alt="asosnoviy" src="https://avatars.githubusercontent.com/u/15638529?v=4&s=117" width="117">](https://github.com/asosnoviy) |[<img alt="AlexPCRus" src="https://avatars.githubusercontent.com/u/47207960?v=4&s=117" width="117">](https://github.com/AlexPCRus) |
|[azazulov](https://github.com/azazulov) |[ViktorErmakov](https://github.com/ViktorErmakov) |[asosnoviy](https://github.com/asosnoviy) |[AlexPCRus](https://github.com/AlexPCRus) |
|[<img alt="1cgh" src="https://avatars.githubusercontent.com/u/24507052?v=4&s=117" width="117">](https://github.com/1cgh) |[<img alt="RichardTheLionJokes" src="https://avatars.githubusercontent.com/u/80366701?v=4&s=117" width="117">](https://github.com/RichardTheLionJokes) |[<img alt="petypen" src="https://avatars.githubusercontent.com/u/6500075?v=4&s=117" width="117">](https://github.com/petypen) |[<img alt="goodwinvu" src="https://avatars.githubusercontent.com/u/32670094?v=4&s=117" width="117">](https://github.com/goodwinvu) |
|[1cgh](https://github.com/1cgh) |[RichardTheLionJokes](https://github.com/RichardTheLionJokes) |[petypen](https://github.com/petypen) |[goodwinvu](https://github.com/goodwinvu) |
|[<img alt="BlizD" src="https://avatars.githubusercontent.com/u/10989306?v=4&s=117" width="117">](https://github.com/BlizD) |[<img alt="igostv" src="https://avatars.githubusercontent.com/u/15666182?v=4&s=117" width="117">](https://github.com/igostv) |[<img alt="sfaqer" src="https://avatars.githubusercontent.com/u/32082417?v=4&s=117" width="117">](https://github.com/sfaqer) |[<img alt="marusov" src="https://avatars.githubusercontent.com/u/33880463?v=4&s=117" width="117">](https://github.com/marusov) |
|[BlizD](https://github.com/BlizD) |[igostv](https://github.com/igostv) |[sfaqer](https://github.com/sfaqer) |[marusov](https://github.com/marusov) |